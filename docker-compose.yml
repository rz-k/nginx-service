services:
  fastapi:
    build: .
    expose:
      - "8000"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./certbot/certs/conf/options-ssl-nginx.conf:/etc/letsencrypt/options-ssl-nginx.conf
      - ./certbot/certs/dhparam.pem:/etc/letsencrypt/ssl-dhparams.pem
      - ./certbot/www:/var/www/certbot
      - ./certbot/certs:/etc/letsencrypt
    depends_on:
      - fastapi
    command: nginx -g "daemon off;"
    restart: unless-stopped

  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/certs:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - nginx
    entrypoint: >
      /bin/sh -c "
      if [ ! -d /etc/letsencrypt/live/test.gray-city.ir ]; then
        echo 'در حال دریافت گواهی اولیه برای test.gray-city.ir...';
        certbot certonly --webroot
          --webroot-path=/var/www/certbot
          --domain test.gray-city.ir
          --email your-email@example.com
          --agree-tos
          --no-eff-email
          --non-interactive
          --keep-until-expiring
          || echo '⚠️ دریافت گواهی اولیه ناموفق بود یا قبلاً انجام شده';
      fi;
      while true; do
        echo '🔄 بررسی تمدید گواهی...';
        certbot renew --quiet --no-self-upgrade --post-hook 'nginx -s reload';
        sleep 43200;
      done
      "
    restart: unless-stopped